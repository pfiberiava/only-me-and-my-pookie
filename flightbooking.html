<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Iberia VA - Book Flight</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Poppins for headings, Inter for body -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://ik.imagekit.io/hswtnwf8i/iberia%20colors.png?updatedAt=1753001611287" type="image/png">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth; /* Smooth scrolling for navigation */
            background-color: #0F172A; /* Slate-900 for a dark theme */
            color: #E2E8F0; /* Slate-200 for text */
            /* Background image for the entire body */
            background-image: url('https://ik.imagekit.io/hswtnwf8i/a320%20beria.png?updatedAt=1752938799277');
            background-size: cover; /* Cover the entire viewport */
            background-position: center; /* Center the background image */
            background-attachment: fixed; /* Keep the background fixed during scroll */
        }
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
            color: #F8FAFC; /* White for headings */
        }
        /* Custom styles for hero section background overlay */
        .hero-overlay {
            /* Adjusted for better visibility with a background image */
            background-image: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.6) 100%);
        }
        /* Style for scroll-to-top button */
        #scrollToTopBtn {
            display: none; /* Hidden by default */
            position: fixed; /* Fixed position */
            bottom: 20px; /* Place at the bottom */
            right: 20px; /* Place at the right */
            z-index: 100; /* High z-index to be on top */
            background-color: #DC2626; /* Red-600 */
            color: white;
            padding: 12px 18px;
            border-radius: 9999px; /* Fully rounded */
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: background-color 0.3s ease, transform 0.3s ease;
            cursor: pointer;
        }
        #scrollToTopBtn:hover {
            background-color: #B91C1C; /* Red-700 */
            transform: translateY(-3px);
        }
        /* Basic icon styling for SVG consistency */
        .icon-lg {
            width: 4rem; /* 64px */
            height: 4rem; /* 64px */
        }
        /* Card hover effect */
        .card-hover-effect {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card-hover-effect:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.3);
        }
        /* Button hover effect */
        .btn-primary {
            background-color: #DC2626; /* Red-600 */
            color: white;
            font-weight: bold;
            padding: 0.75rem 2rem;
            border-radius: 9999px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #B91C1C; /* Red-700 */
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
        }
        /* Discord Login Button and User Info Styling */
        .discord-login-btn {
            @apply flex items-center justify-center space-x-2 px-6 py-3 rounded-full text-base font-semibold; /* Increased padding and font size */
            background-color: #5865F2; /* Discord Blue */
            color: white;
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Stronger shadow */
        }
        .discord-login-btn:hover {
            background-color: #4752C4; /* Darker Discord Blue */
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3); /* Stronger hover shadow */
        }
        .discord-login-btn svg {
            @apply w-6 h-6; /* Larger icon */
        }
          .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #E2E8F0; /* Slate-200 */
            font-weight: 600;
        }
        .user-info img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #DC2626; /* Red-600 */
        }
        .logout-button {
            background-color: #DC2626; /* Red-600 */
            color: white;
            padding: 0.5rem 1.2rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .logout-button:hover {
            background-color: #B91C1C; /* Red-700 */
        }

        /* From Uiverse.io by vinodjangid07 */ 
        .Btn {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background-color: transparent;
            position: relative;
            /* overflow: hidden; */
            border-radius: 7px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .svgContainer {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: transparent;
            backdrop-filter: blur(0px);
            letter-spacing: 0.8px;
            border-radius: 10px;
            transition: all 0.3s;
            border: 1px solid rgba(156, 156, 156, 0.466);
        }

        .BG {
            position: absolute;
            content: "";
            width: 100%;
            height: 100%;
            background: #7289da;
            z-index: -1;
            border-radius: 10px;
            pointer-events: none;
            transition: all 0.3s;
        }

        .Btn:hover .BG {
            transform: rotate(35deg);
            transform-origin: bottom;
        }

        .Btn:hover .svgContainer {
            border: 1px solid rgba(206, 206, 206, 0.466);
            background-color: rgba(214, 214, 214, 0.466);
            backdrop-filter: blur(4px);
        }

        /* Loading Screen Styles */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #0F172A; /* Dark background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999; /* High z-index to cover everything */
            flex-direction: column;
            gap: 20px;
        }

        .video-container {
            width: 200px; /* Adjust size as needed */
            height: 200px; /* Adjust size as needed */
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border: 5px solid #DC2626; /* Red border for emphasis */
        }
        .video-container iframe {
            display: block; /* Remove extra space below iframe */
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="video-container">
            <video src="iberia animation.gif" frameborder="0" width="100%" height="100%" allowfullscreen allow="autoplay"></video>
        </div>
        <p class="text-xl font-semibold text-white">Loading...</p>
    </div>

    <!-- Main Content Wrapper (all existing content goes inside here) -->
    <div id="main-content" style="display: none;">
        <!-- Header -->
        <header class="bg-gray-900 shadow-lg fixed w-full z-10">
            <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
                <!-- Logo/Brand -->
                <div class="flex items-center">
                    <img src="https://ik.imagekit.io/hswtnwf8i/iberia%20colors.png?updatedAt=1753001611287" alt="Iberia VA Logo" class="h-10 w-auto mr-2"/>
                    <a href="https://pfiberiava.github.io/flyibe/" class="text-2xl font-bold text-white rounded-md hover:text-red-500 transition duration-300">
                        Iberia VA
                    </a>
                </div>

                <!-- Desktop Navigation -->
                <div class="hidden md:flex space-x-8">
                    <a href="index.html" class="text-lg font-medium text-gray-300 hover:text-red-500 transition duration-300 px-3 py-2 rounded-md">Home</a>
                    <a href="#booking" class="text-lg font-medium text-gray-300 hover:text-red-500 transition duration-300 px-3 py-2 rounded-md">Book a Flight</a>
                    <a href="#contact" class="text-lg font-medium text-gray-300 hover:text-red-500 transition duration-300 px-3 py-2 rounded-md">Contact</a>
                </div>

                <!-- Discord Auth Section for Desktop -->
                <div id="desktop-user-actions" class="user-actions hidden md:flex items-center space-x-2">
                    <!-- Content injected by JS -->
                </div>

                <!-- Mobile Menu Button -->
                <div class="md:hidden">
                    <button id="mobile-menu-button" class="text-gray-300 hover:text-red-500 focus:outline-none focus:ring-2 focus:ring-red-500 rounded-md p-2">
                        <svg id="menu-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
                        <svg id="close-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                </div>
            </nav>

            <!-- Mobile Menu -->
            <div id="mobile-menu" class="md:hidden hidden bg-gray-800 py-4 shadow-lg">
                <div class="flex flex-col items-center space-y-4">
                    <a href="index.html" class="text-lg font-medium text-gray-300 hover:text-red-500 transition duration-300 w-full text-center py-2 rounded-md" onclick="closeMobileMenu()">Home</a>
                    <a href="#booking" class="text-lg font-medium text-gray-300 hover:text-red-500 transition duration-300 w-full text-center py-2 rounded-md" onclick="closeMobileMenu()">Book a Flight</a>
                    <a href="#contact" class="text-lg font-medium text-gray-300 hover:text-red-500 transition duration-300 w-full text-center py-2 rounded-md" onclick="closeMobileMenu()">Contact</a>
                    <!-- Discord Auth Section for Mobile -->
                    <div id="mobile-user-actions" class="user-actions w-full text-center py-2">
                        <!-- Content injected by JS -->
                    </div>
                </div>
            </div>
        </header>

         <main class="container container-sleek mx-auto py-section-sleek px-6 md:px-12">
        <section id="booking-form-section" class="card-background-sleek p-8 md:p-12 mb-content-sleek relative overflow-hidden">
            <h2 class="section-heading-sleek text-center mx-auto mb-10">Book Your Virtual Flight</h2>
            <p class="text-center text-lg mb-10 max-w-2xl mx-auto text-slate-500">
                Plan your next virtual journey with Air Europa Virtual. Select your departure, arrival, and flight details below.
            </p>

            <div class="max-w-xl mx-auto form-container-sleek">
                <form id="flightBookingForm" action="https://formcarry.com/s/B6IGRQkIQFb" method="POST" class="space-y-6">
                    <input type="hidden" name="Discord Username" id="discordUsernameHidden">
                    <div>
                        <label for="origin" class="block text-slate-700 text-sm font-semibold mb-2">Departure Airport:</label>
                        <select id="origin" name="Departure Airport" class="input-field-sleek w-full" required>
                            <option value="">Select Departure Airport</option>
                            </select>
                    </div>

                    <div>
                        <label for="destination" class="block text-slate-700 text-sm font-semibold mb-2">Arrival Airport:</label>
                        <select id="destination" name="Arrival Airport" class="input-field-sleek w-full" required>
                            <option value="">Select Arrival Airport</option>
                            </select>
                    </div>

                    <div>
                        <label for="flight-date" class="block text-slate-700 text-sm font-semibold mb-2">Departure Date:</label>
                        <input type="date" id="flight-date" name="Departure Date" class="input-field-sleek w-full" required>
                    </div>

                    <div>
                        <label for="passengers" class="block text-slate-700 text-sm font-semibold mb-2">Number of Passengers:</label>
                        <input type="number" id="passengers" name="Number of Passengers" min="1" value="1" class="input-field-sleek w-full" required>
                    </div>

                    <div>
                        <label for="flight-class" class="block text-slate-700 text-sm font-semibold mb-2">Class:</label>
                        <select id="flight-class" name="Flight Class" class="input-field-sleek w-full" required>
                            <option value="Economy">Economy</option>
                            <option value="Business">Business</option>
                            <option value="First Class">First Class</option>
                        </select>
                    </div>

                    <div class="flex justify-center pt-4">
                        <button type="submit" class="btn-submit-sleek">
                            Submit Booking
                        </button>
                    </div>
                </form>
            </div>
        </section>
    </main>

    <div id="messageBoxOverlay" class="message-box-overlay">
        <div class="message-box-content">
            <h3 id="messageBoxTitle" class="text-2xl font-bold"></h3>
            <p id="messageBoxText"></p>
            <button id="messageBoxCloseButton">Close</button>
        </div>
    </div>

        <!-- Scroll to Top Button -->
        <button id="scrollToTopBtn" title="Go to top">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18"/></svg>
        </button>

        <!-- Footer -->
        <footer class="bg-gray-950 text-gray-400 py-8">
            <div class="container mx-auto px-6 text-center">
                <p class="mb-4">Â© <span id="current-year"></span> Iberia VA. All rights reserved.</p>
                <div class="flex justify-center space-x-6">
                    <a href="https://www.instagram.com/iberiava_pf/" class="hover:text-white transition duration-300">Instagram</a>
                    <a href="https://www.youtube.com/channel/UCahgitUZD7SNT2pVCie3ymQ" class="hover:text-white transition duration-300">Youtube</a>
                    <a href="https://discord.gg/vcfDHnpK22" class="hover:text-white transition duration-300">Discord</a>
                </div>
            </div>
        </footer>
    </div> <!-- End of main-content wrapper -->

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Get the current year for the footer
            document.getElementById('current-year').textContent = new Date().getFullYear();

            // Mobile menu toggle logic
            const mobileMenuButton = document.getElementById('mobile-menu-button');
            const mobileMenu = document.getElementById('mobile-menu');
            const menuIcon = document.getElementById('menu-icon');
            const closeIcon = document.getElementById('close-icon');

            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
                menuIcon.classList.toggle('hidden');
                closeIcon.classList.toggle('hidden');
            });

            // Function to close mobile menu when a link is clicked
            function closeMobileMenu() {
                mobileMenu.classList.add('hidden');
                menuIcon.classList.remove('hidden');
                closeIcon.classList.add('hidden');
            }

            // Scroll to top button logic
            const scrollToTopBtn = document.getElementById('scrollToTopBtn');

            // When the user scrolls down 20px from the top of the document, show the button
            window.onscroll = function() { scrollFunction() };

            function scrollFunction() {
                if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                    scrollToTopBtn.style.display = "block";
                } else {
                    scrollToTopBtn.style.display = "none";
                }
            }

            // When the user clicks on the button, scroll to the top of the document
            scrollToTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            // Loading Screen Logic
            const loadingScreen = document.getElementById('loading-screen');
            const mainContent = document.getElementById('main-content');
            // The video is short, around 5-6 seconds. Set a timeout slightly longer.
            const videoDurationMs = 6500; // 6.5 seconds

            // Hide main content initially
            mainContent.style.display = 'none';

            // After the estimated video duration, hide the loading screen and show main content
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                mainContent.style.display = 'block';
            }, videoDurationMs);


            // Flight data based on your provided routes
           const airports = [
            "Gran Canaria", "Punta Cana", "Larnaca", "London Gatwick",
            "London Southampton", "Kittila", "Cibao", "Arroyo Barril", "Menorca"
        ].sort(); // Sort alphabetically for better user experience

        document.addEventListener('DOMContentLoaded', () => {
            const originSelect = document.getElementById('origin');
            const destinationSelect = document.getElementById('destination');
            const flightBookingForm = document.getElementById('flightBookingForm');
            const discordUsernameHidden = document.getElementById('discordUsernameHidden');
            // const discordEmailHidden = document.getElementById('discordEmailHidden'); // Uncomment if you get email from Discord

            const messageBoxOverlay = document.getElementById('messageBoxOverlay');
            const messageBoxTitle = document.getElementById('messageBoxTitle');
            const messageBoxText = document.getElementById('messageBoxText');
            const messageBoxCloseButton = document.getElementById('messageBoxCloseButton');

            // Function to show custom message box
            function showMessageBox(title, message) {
                messageBoxTitle.textContent = title;
                messageBoxText.textContent = message;
                messageBoxOverlay.classList.add('show');
            }

            // Function to hide custom message box
            function hideMessageBox() {
                messageBoxOverlay.classList.remove('show');
            }

            // Populate dropdowns with airport options
            function populateAirportSelects() {
                airports.forEach(airport => {
                    const optionOrigin = document.createElement('option');
                    optionOrigin.value = airport;
                    optionOrigin.textContent = airport;
                    originSelect.appendChild(optionOrigin);

                    const optionDestination = document.createElement('option');
                    optionDestination.value = airport;
                    optionDestination.textContent = airport;
                    destinationSelect.appendChild(optionDestination);
                });
            }

            populateAirportSelects();

            // Populate Discord username from localStorage
            const userFromLocalStorage = JSON.parse(localStorage.getItem("discordUser"));
            if (userFromLocalStorage && userFromLocalStorage.username) {
                // For modern Discord usernames (without discriminator)
                const username = userFromLocalStorage.discriminator && userFromLocalStorage.discriminator !== '0'
                    ? `${userFromLocalStorage.username}#${userFromLocalStorage.discriminator}`
                    : userFromLocalStorage.username;
                discordUsernameHidden.value = username;
                // if (savedUser.email) { // Uncomment if you get email from Discord
                //     discordEmailHidden.value = savedUser.email;
                // }
            } else {
                discordUsernameHidden.value = "Not Logged In (or error)";
            }


            // Handle form submission
            flightBookingForm.addEventListener('submit', async (event) => {
                event.preventDefault(); // Prevent default form submission

                const origin = originSelect.value;
                const destination = destinationSelect.value;
                const flightDate = document.getElementById('flight-date').value;
                const passengers = document.getElementById('passengers').value;
                const flightClass = document.getElementById('flight-class').value; // Get the selected class

                // Basic validation
                if (origin === "" || destination === "" || flightDate === "" || passengers === "" || flightClass === "") {
                    showMessageBox("Validation Error", "Please fill in all flight details.");
                    return;
                }

                if (origin === destination) {
                    showMessageBox("Invalid Route", "Departure and Arrival airports cannot be the same. Please select different airports.");
                    return;
                }

                // Use FormData to easily get all form data
                const formData = new FormData(flightBookingForm);

                try {
                    const response = await fetch(flightBookingForm.action, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'Accept': 'application/json' // Important for Formcarry to return JSON
                        }
                    });

                    if (response.ok) {
                        showMessageBox("Booking Submitted!", "Your flight booking request has been successfully sent. We will get back to you shortly!");
                        flightBookingForm.reset(); // Clear form after successful submission
                    } else {
                        const data = await response.json();
                        // Formcarry returns errors in 'data.errors' if validation fails or other issues.
                        // You might want to inspect `data` for specific error messages from Formcarry.
                        if (data.errors) {
                            showMessageBox("Submission Failed", `There was an issue with your submission: ${data.errors.map(err => err.message).join(', ')}. Please try again.`);
                        } else {
                            showMessageBox("Submission Failed", "There was an error submitting your booking. Please try again later.");
                        }
                    }
                } catch (error) {
                    console.error('Error submitting form:', error);
                    showMessageBox("Submission Error", "An unexpected error occurred. Please check your internet connection and try again.");
                }
            });

            // Close message box when button is clicked
            messageBoxCloseButton.addEventListener('click', hideMessageBox);
            // Close message box if clicking outside the content
            messageBoxOverlay.addEventListener('click', (event) => {
                if (event.target === messageBoxOverlay) {
                    hideMessageBox();
                }
            });
        });

            // Discord Login Integration
            // Your Discord Client ID from the Discord Developer Portal
            const CLIENT_ID = "1396149795470446692";
            // The Redirect URI must EXACTLY match what's configured in your Discord OAuth2 settings
            const REDIRECT_URI = "https://pfiberiava.github.io/flyibe/flightbooking.html"; // Updated redirect URI for flight booking page

            // Discord authorization URL - CRITICAL: Changed response_type to 'token'
            const AUTH_URL = `https://discord.com/oauth2/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=identify`;

            // Select all divs where user actions will be displayed
            const userActionsDivs = document.querySelectorAll(".user-actions");

            // Function to display user information and the logout button
            function showUser(user) {
                const avatarUrl = user.avatar ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png` : 'https://discord.com/assets/f135b1fcd3d2c4935480d19e910540d5.png';
                userActionsDivs.forEach(div => {
                    div.innerHTML = `
                        <div class="user-info">
                            <img src="${avatarUrl}" alt="User Avatar">
                            <span>${user.username}</span>
                            <button class="logout-button">Logout</button>
                        </div>
                    `;
                    const logoutButton = div.querySelector(".logout-button");
                    if (logoutButton) {
                        logoutButton.onclick = () => {
                            localStorage.removeItem("discordUser");
                            window.location.href = REDIRECT_URI; // Reload to reset state and clear URL hash
                        };
                    }
                });
                // Hide login message and enable form
                if (loginRequiredMessage) loginRequiredMessage.classList.add('hidden');
                if (flightBookingForm) flightBookingForm.classList.remove('hidden');
                toggleFormFields(true);
            }

            // Function to display the Discord login button
            function showLoginButton() {
                userActionsDivs.forEach(div => {
                    div.innerHTML = `
                       <a href="${AUTH_URL}"  class="Btn">
      <span class="svgContainer">
        <svg
          viewBox="0 0 640 512"
          fill="white"
          height="1.4em"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            d="M524.5 69.8a1.5 1.5 0 0 0 -.8-.7A485.1 485.1 0 0 0 404.1 32a1.8 1.8 0 0 0 -1.9 .9 337.5 337.5 0 0 0 -14.9 30.6 447.8 447.8 0 0 0 -134.4 0 309.5 309.5 0 0 0 -15.1-30.6 1.9 1.9 0 0 0 -1.9-.9A483.7 483.7 0 0 0 116.1 69.1a1.7 1.7 0 0 0 -.8 .7C39.1 183.7 18.2 294.7 28.4 404.4a2 2 0 0 0 .8 1.4A487.7 487.7 0 0 0 176 479.9a1.9 1.9 0 0 0 2.1-.7A348.2 348.2 0 0 0 208.1 430.4a1.9 1.9 0 0 0 -1-2.6 321.2 321.2 0 0 1 -45.9-21.9 1.9 1.9 0 0 1 -.2-3.1c3.1-2.3 6.2-4.7 9.1-7.1a1.8 1.8 0 0 1 1.9-.3c96.2 43.9 200.4 43.9 295.5 0a1.8 1.8 0 0 1 1.9 .2c2.9 2.4 6 4.9 9.1 7.2a1.9 1.9 0 0 1 -.2 3.1 301.4 301.4 0 0 1 -45.9 21.8 1.9 1.9 0 0 0 -1 2.6 391.1 391.1 0 0 0 30 48.8 1.9 1.9 0 0 0 2.1 .7A486 486 0 0 0 610.7 405.7a1.9 1.9 0 0 0 .8-1.4C623.7 277.6 590.9 167.5 524.5 69.8zM222.5 337.6c-29 0-52.8-26.6-52.8-59.2S193.1 219.1 222.5 219.1c29.7 0 53.3 26.8 52.8 59.2C275.3 311 251.9 337.6 222.5 337.6zm195.4 0c-29 0-52.8-26.6-52.8-59.2S388.4 219.1 417.9 219.1c29.7 0 53.3 26.8 52.8 59.2C470.7 311 447.5 337.6 417.9 337.6z"
          ></path>
        </svg>
      </span>
      <span class="BG"></span>
    </a>
                    `;
                });
                // Display login message and disable form
                if (loginRequiredMessage) {
                    loginRequiredMessage.classList.remove('hidden');
                    // Ensure the login button is rendered inside the message div
                    const loginBtnHtml = `
                       <a href="${AUTH_URL}" class="Btn">
                            <span class="svgContainer">
                                <svg viewBox="0 0 640 512" fill="white" height="1.4em" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M524.5 69.8a1.5 1.5 0 0 0 -.8-.7A485.1 485.1 0 0 0 404.1 32a1.8 1.8 0 0 0 -1.9 .9 337.5 337.5 0 0 0 -14.9 30.6 447.8 447.8 0 0 0 -134.4 0 309.5 309.5 0 0 0 -15.1-30.6 1.9 1.9 0 0 0 -1.9-.9A483.7 483.7 0 0 0 116.1 69.1a1.7 1.7 0 0 0 -.8 .7C39.1 183.7 18.2 294.7 28.4 404.4a2 2 0 0 0 .8 1.4A487.7 487.7 0 0 0 176 479.9a1.9 1.9 0 0 0 2.1-.7A348.2 348.2 0 0 0 208.1 430.4a1.9 1.9 0 0 0 -1-2.6 321.2 321.2 0 0 1 -45.9-21.9 1.9 1.9 0 0 1 -.2-3.1c3.1-2.3 6.2-4.7 9.1-7.1a1.8 1.8 0 0 1 1.9-.3c96.2 43.9 200.4 43.9 295.5 0a1.8 1.8 0 0 1 1.9 .2c2.9 2.4 6 4.9 9.1 7.2a1.9 1.9 0 0 1 -.2 3.1 301.4 301.4 0 0 1 -45.9 21.8 1.9 1.9 0 0 0 -1 2.6 391.1 391.1 0 0 0 30 48.8 1.9 1.9 0 0 0 2.1 .7A486 486 0 0 0 610.7 405.7a1.9 1.9 0 0 0 .8-1.4C623.7 277.6 590.9 167.5 524.5 69.8zM222.5 337.6c-29 0-52.8-26.6-52.8-59.2S193.1 219.1 222.5 219.1c29.7 0 53.3 26.8 52.8 59.2C275.3 311 251.9 337.6 222.5 337.6zm195.4 0c-29 0-52.8-26.6-52.8-59.2S388.4 219.1 417.9 219.1c29.7 0 53.3 26.8 52.8 59.2C470.7 311 447.5 337.6 417.9 337.6z"></path>
                                </svg>
                            </span>
                            <span class="BG"></span>
                        </a>
                    `;
                    if (loginButtonContainer) loginButtonContainer.innerHTML = loginBtnHtml;
                }
                if (flightBookingForm) flightBookingForm.classList.add('hidden');
                toggleFormFields(false);
            }

            // --- Main login state management logic ---
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const token = params.get("access_token"); // We are now expecting 'access_token'

            const savedUser = JSON.parse(localStorage.getItem("discordUser"));

            if (token) {
                // If a token is present in the URL (after a new Discord login)
                window.history.replaceState({}, document.title, REDIRECT_URI); // Clean the URL

                fetch("https://discord.com/api/users/@me", {
                    headers: {
                        Authorization: `Bearer ${token}`
                    }
                })
                .then(res => {
                    if (!res.ok) {
                        console.error("Discord API error:", res.status, res.statusText);
                        localStorage.removeItem("discordUser"); // Clear stale user data
                        showLoginButton();
                        throw new Error("Failed to fetch user data from Discord");
                    }
                    return res.json();
                })
                .then(user => {
                    if (user.id) {
                        localStorage.setItem("discordUser", JSON.stringify(user));
                        showUser(user);
                    } else {
                        console.error("Invalid Discord user data received:", user);
                        localStorage.removeItem("discordUser");
                        showLoginButton();
                    }
                })
                .catch(error => {
                    console.error("Error during Discord user fetch or processing:", error);
                    localStorage.removeItem("discordUser");
                    showLoginButton();
                });
            } else if (savedUser) {
                showUser(savedUser);
            } else {
                showLoginButton();
            }
        });
    </script>
</body>
</html>
